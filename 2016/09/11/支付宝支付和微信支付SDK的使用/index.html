<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>支付宝支付和微信支付SDK的使用 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="目前工作的项目(投顾业务)中已有微信支付功能，下一步是要加入支付宝支付，结合项目代码来总结下两种sdk的使用。 微信支付客户端——&amp;gt;本地接口一、充值页面（DklcRecharge） 1.先getPaymentList()，从接口获取”支付列表”，并将其放入GPaymentlist实体类中。 2.从接口获得金豆选项view 3.点击支付事件：弹出一个PopWindow。  二、popwin">
<meta name="keywords" content="Code">
<meta property="og:type" content="article">
<meta property="og:title" content="支付宝支付和微信支付SDK的使用">
<meta property="og:url" content="http://yoursite.com/2016/09/11/支付宝支付和微信支付SDK的使用/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="目前工作的项目(投顾业务)中已有微信支付功能，下一步是要加入支付宝支付，结合项目代码来总结下两种sdk的使用。 微信支付客户端——&amp;gt;本地接口一、充值页面（DklcRecharge） 1.先getPaymentList()，从接口获取”支付列表”，并将其放入GPaymentlist实体类中。 2.从接口获得金豆选项view 3.点击支付事件：弹出一个PopWindow。  二、popwin">
<meta property="og:updated_time" content="2017-04-18T04:11:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="支付宝支付和微信支付SDK的使用">
<meta name="twitter:description" content="目前工作的项目(投顾业务)中已有微信支付功能，下一步是要加入支付宝支付，结合项目代码来总结下两种sdk的使用。 微信支付客户端——&amp;gt;本地接口一、充值页面（DklcRecharge） 1.先getPaymentList()，从接口获取”支付列表”，并将其放入GPaymentlist实体类中。 2.从接口获得金豆选项view 3.点击支付事件：弹出一个PopWindow。  二、popwin">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-支付宝支付和微信支付SDK的使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/11/支付宝支付和微信支付SDK的使用/" class="article-date">
  <time datetime="2016-09-11T15:23:03.000Z" itemprop="datePublished">2016-09-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      支付宝支付和微信支付SDK的使用
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>　　目前工作的项目(投顾业务)中已有微信支付功能，下一步是要加入支付宝支付，结合项目代码来总结下两种sdk的使用。</p>
<h1 id="微信支付"><a href="#微信支付" class="headerlink" title="微信支付"></a>微信支付</h1><h2 id="客户端——-gt-本地接口"><a href="#客户端——-gt-本地接口" class="headerlink" title="客户端——&gt;本地接口"></a>客户端——&gt;本地接口</h2><h3 id="一、充值页面（DklcRecharge）"><a href="#一、充值页面（DklcRecharge）" class="headerlink" title="一、充值页面（DklcRecharge）"></a>一、充值页面（DklcRecharge）</h3><ul>
<li>1.先getPaymentList()，从接口获取”支付列表”，并将其放入GPaymentlist实体类中。</li>
<li>2.从接口获得金豆选项view</li>
<li>3.点击支付事件：弹出一个PopWindow。</li>
</ul>
<h3 id="二、popwindow（PayPopWindow）"><a href="#二、popwindow（PayPopWindow）" class="headerlink" title="二、popwindow（PayPopWindow）"></a>二、popwindow（PayPopWindow）</h3><ul>
<li>1.获取以下内容：<br>  投顾ID，充值金额（GPaymentlist类的keyvalue变量），ip地址（分wifi和流量两种途径获取），交易类型（APP），body（GPaymentlist类的descr变量，并用UTF-8编码），金豆比率（GPaymentlist类的id变量）。</li>
<li>2.点击微信支付事件：调用自定义WeiXinPay类的requestPay()方法，将上述6个值传入。</li>
</ul>
<h3 id="三、请求接口，获取数据（WeiXinPay）"><a href="#三、请求接口，获取数据（WeiXinPay）" class="headerlink" title="三、请求接口，获取数据（WeiXinPay）"></a>三、请求接口，获取数据（WeiXinPay）</h3><ul>
<li><p>1.构造器中注册APP：<br>  1&gt;.创建微信SDK“IWXAPI类”的对象：IWXAPI api = WXAPIFactory.createWXAPI(context，APPID(获取方法见下))。<br>  2&gt;.调用微信SDK“IWXAPI类”的registerApp()方法，传入APPID。<br>  3&gt;.APPID来源：<br>   在微信开放平台填写包名和签名后可注册应用，注册应用后得到appid。<br>   项目中写在了function.properties文件中——wx973da9dd05403d3e，<br>   通过MiddlewareProxy.getFunctionManager().getProperty()方式获取，安卓原生获取方法是：<br>   Properties pro = new Properties();<br>   InputStream is = context.getAssets().open(“function.properties”);<br>   pro.load(is);</p>
</li>
<li><p>2.向本地接口发送请求<br>  判断完”是否安装微信”，”微信版本是否支持支付”之后，传入上述6个值开始发送请求</p>
</li>
</ul>
<h2 id="本地接口——-gt-客户端"><a href="#本地接口——-gt-客户端" class="headerlink" title="本地接口——&gt;客户端"></a>本地接口——&gt;客户端</h2><ul>
<li>3.处理数据<br>  1&gt;.获取的数据放在实体类里，包括appid , partnerid , prepayid , sign , noncestr , tiemstamp 7个值。<br>  2&gt;.新建SDK中的类PayReq的对象，将7个值放入该类的7个变量里</li>
</ul>
<h2 id="客户端——-gt-微信服务器"><a href="#客户端——-gt-微信服务器" class="headerlink" title="客户端——&gt;微信服务器"></a>客户端——&gt;微信服务器</h2><p>　　3&gt;.调用IWXAPI的sendReq()方法，将PayReq对象传入。完成。</p>
<h1 id="支付宝支付"><a href="#支付宝支付" class="headerlink" title="支付宝支付"></a>支付宝支付</h1><h2 id="客户端——-gt-本地接口-1"><a href="#客户端——-gt-本地接口-1" class="headerlink" title="客户端——&gt;本地接口"></a>客户端——&gt;本地接口</h2><h3 id="一、充值页面"><a href="#一、充值页面" class="headerlink" title="一、充值页面"></a>一、充值页面</h3><p>   同微信</p>
<h3 id="二、popwindow"><a href="#二、popwindow" class="headerlink" title="二、popwindow"></a>二、popwindow</h3><p>   基本同微信。<br>   将n个本地值拼成url，在子线程中传给项目类MobileSecurePayer的自定义方法requestOrderInfo()方法中。</p>
<h3 id="三、请求接口，获取数据（MobileSecurePayer类）"><a href="#三、请求接口，获取数据（MobileSecurePayer类）" class="headerlink" title="三、请求接口，获取数据（MobileSecurePayer类）"></a>三、请求接口，获取数据（MobileSecurePayer类）</h3><p>　* 1.请求接口<br>     requestOrderInfo()中进行HttpURLConnection网络请求，返回的json中应该包括了如下数据：</p>
<h2 id="本地接口——-gt-客户端-1"><a href="#本地接口——-gt-客户端-1" class="headerlink" title="本地接口——&gt;客户端"></a>本地接口——&gt;客户端</h2><p>　　body商品描述 ，partner合作商ID , seller商户支付宝号 , sign商户私钥签名 ， out_trade_no外部订单号 ， notify_url支付宝给本地接口的url ， total_fee价格 ， errno错误码 ， subject 9个参数。</p>
<p>　* 2.传递数据<br>　　将数据从子线程传出到主线程。新建Message对象，what字段设为4，obj字段设为获得的json数据，sendMessage()。</p>
<h3 id="四、解析数据"><a href="#四、解析数据" class="headerlink" title="四、解析数据"></a>四、解析数据</h3><ul>
<li>1.Handler接收数据<br>   Handler接口的方法handleMessage()中先判断what字段是否为4，然后提取出obj字段的json数据。</li>
<li>2.解析出订单信息<br>   json数据传递给项目方法getOrderInfo()，在里面对9个变量加入&amp;和\进行拼接成一个stringBuilder，这就是订单信息。</li>
</ul>
<h2 id="客户端——-gt-支付宝服务端"><a href="#客户端——-gt-支付宝服务端" class="headerlink" title="客户端——&gt;支付宝服务端"></a>客户端——&gt;支付宝服务端</h2><h3 id="五、提交订单信息"><a href="#五、提交订单信息" class="headerlink" title="五、提交订单信息"></a>五、提交订单信息</h3><ul>
<li>1.开启支付宝的“安全支付服务”<br>  先在外部newServiceConnection接口，重写onServiceConnected()和onServcieDisconnected()方法，前者：先加同步锁，再mAlixPay=IAlixPay.Stub.asInterface(service), 后者：mAlixPay=null。<br>  在项目方法pay()中bindService()。</li>
<li>2.开启子线程</li>
<li>3.try中提交<br>   1&gt;.先判断同步锁。<br>   2&gt;.为安全支付服务注册回调。 mAliPay.registerCallback(回调对象)。<br>   3&gt;.正式提交，调用mAliPay.pay()，参数传入订单信息。<br>   4&gt;.发送交易结果，新建Message对象，what字段设为1，obj字段设为SDK的pay()的返回值。利用刚才的回调对象sendMessage()。</li>
<li>4.catch中提交<br>   同样的新建Message后发送，obj字段为e。</li>
<li>5.finally中解除回调 + 取绑服务<br>   mAlixPay.unregisterCallback(回调对象)。判断若在绑定，执行unbindService()。</li>
</ul>
<h2 id="支付宝服务端——-gt-客户端"><a href="#支付宝服务端——-gt-客户端" class="headerlink" title="支付宝服务端——&gt;客户端"></a>支付宝服务端——&gt;客户端</h2><h3 id="六、Handler接收数据"><a href="#六、Handler接收数据" class="headerlink" title="六、Handler接收数据"></a>六、Handler接收数据</h3><ul>
<li>1.Handler接口的方法handleMessage()中先判断what字段是否为1。</li>
<li>2.新建签名检验类ResultChecker对象，构造函数中传入obj字段。</li>
<li>3.ResultChecker对象调用getResultStatus()，获得支付状态，支付状态若等于9000，表示支付成功。</li>
<li>4.清除handler,lock,context,serviceConnection,callback。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/11/支付宝支付和微信支付SDK的使用/" data-id="cj2n6xnu50017vdpdyci3tfg9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Code/">Code</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/09/14/获取屏幕数值/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          获取屏幕数值
        
      </div>
    </a>
  
  
    <a href="/2016/08/25/2016-8-12晚观星/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2016.8.12晚观星</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Code/">Code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hardware/">Hardware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/movie/">movie</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/science/">science</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Code/" style="font-size: 20px;">Code</a> <a href="/tags/Hardware/" style="font-size: 10px;">Hardware</a> <a href="/tags/code/" style="font-size: 16.67px;">code</a> <a href="/tags/movie/" style="font-size: 13.33px;">movie</a> <a href="/tags/science/" style="font-size: 10px;">science</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/04/18/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2016/09/19/github模式/">MVP模式</a>
          </li>
        
          <li>
            <a href="/2016/09/17/跟投设置页面开发笔记/">跟投设置页面开发笔记</a>
          </li>
        
          <li>
            <a href="/2016/09/14/获取屏幕数值/">获取屏幕数值</a>
          </li>
        
          <li>
            <a href="/2016/09/11/支付宝支付和微信支付SDK的使用/">支付宝支付和微信支付SDK的使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>